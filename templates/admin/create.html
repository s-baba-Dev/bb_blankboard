{% extends "base_admin.html" %}

{% block title %}新規投稿 - 管理者{% endblock %}

{% block content %}

<h1 class="text-3xl font-bold mb-6">新規投稿</h1>

<!--
  新規投稿フォーム
  ・POST /admin/posts/new
  ・カテゴリ / トピック / グループは JS で連動制御
  ・本文は Toast UI Editor を使用
-->
<div class="bg-white p-8 rounded-lg shadow">
    <form action="/admin/posts/new" method="post">

        <!-- ======================= -->
        <!-- タイトル -->
        <!-- ======================= -->
        <!--
          投稿タイトル
          ・必須入力
          ・そのまま posts.json の title に保存される
        -->
        <label class="block font-semibold mb-2">タイトル</label>
        <input type="text" name="title" required
               class="w-full border border-gray-300 rounded px-3 py-2 mb-6">

        <!-- ======================= -->
        <!-- ★ カテゴリ設定 ★ -->
        <!-- ======================= -->
        <!--
          カテゴリ / トピック / グループ設定
          ・既存選択 or 新規作成をラジオで切り替え
          ・category_control.js が制御
        -->
        <h2 class="text-xl font-bold mb-4 mt-6">カテゴリ設定</h2>

        <!-- ===== Category ===== -->
        <div class="mb-6">
            <!--
              カテゴリ設定
              ・existing : 既存カテゴリ select を使用
              ・new      : 新規カテゴリ input を使用
            -->
            <label class="block font-semibold mb-1">カテゴリ</label>

            <label class="mr-4">
                <input type="radio" name="category_mode" value="existing" checked>
                既存カテゴリから選択
            </label>

            <label>
                <input type="radio" name="category_mode" value="new">
                新規カテゴリを作成
            </label>

            <!--
              JS契約:
              ・id="category_select" を起点に topic を絞り込み
            -->
            <select id="category_select" name="category_id"
                    class="w-full border border-gray-300 rounded px-3 py-2 mt-2">
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>

            <!--
              新規カテゴリ入力欄
              ・category_mode === "new" の時のみ表示
            -->
            <input type="text" id="new_category_input" name="new_category_name"
                   class="w-full border border-gray-300 rounded px-3 py-2 mt-2"
                   placeholder="新しいカテゴリ名を入力"
                   style="display:none;">
        </div>

        <!-- ===== Topic ===== -->
        <div class="mb-6">
            <!--
              トピック設定
              ・選択中カテゴリに紐づくトピックのみ表示
              ・新規カテゴリ作成時は自動で new 扱いになる
            -->
            <label class="block font-semibold mb-1">トピピック</label>

            <label class="mr-4">
                <input type="radio" name="topic_mode" value="existing" checked>
                既存トピックから選択
            </label>

            <label>
                <input type="radio" name="topic_mode" value="new">
                新規トピックを作成
            </label>

            <!--
              JS契約:
              ・category_select の変更に応じて options を再生成
            -->
            <select id="topic_select" name="topic_id"
                    class="w-full border border-gray-300 rounded px-3 py-2 mt-2">
                <!-- JSで絞り込み -->
            </select>

            <!--
              新規トピック入力欄
              ・topic_mode === "new" の時のみ表示
            -->
            <input type="text" id="new_topic_input" name="new_topic_name"
                   class="w-full border border-gray-300 rounded px-3 py-2 mt-2"
                   placeholder="新しいトピック名を入力"
                   style="display:none;">
        </div>

        <!-- ===== Group ===== -->
        <div class="mb-6">
            <!--
              グループ設定
              ・選択中トピックに紐づくグループのみ表示
            -->
            <label class="block font-semibold mb-1">グループ</label>

            <label class="mr-4">
                <input type="radio" name="group_mode" value="existing" checked>
                既存グループから選択
            </label>

            <label>
                <input type="radio" name="group_mode" value="new">
                新規グループを作成
            </label>

            <!--
              JS契約:
              ・topic_select の変更に応じて options を再生成
            -->
            <select id="group_select" name="group_id"
                    class="w-full border border-gray-300 rounded px-3 py-2 mt-2">
                <!-- JSで絞り込み -->
            </select>

            <!--
              新規グループ入力欄
              ・group_mode === "new" の時のみ表示
            -->
            <input type="text" id="new_group_input" name="new_group_name"
                   class="w-full border border-gray-300 rounded px-3 py-2 mt-2"
                   placeholder="新しいグループ名を入力"
                   style="display:none;">
        </div>

        <!-- ======================= -->
        <!-- 本文 -->
        <!-- ======================= -->
        <!--
          Toast UI Editor
          ・WYSIWYG編集
          ・送信時に Markdown を hidden input に詰める
        -->
        <label class="block font-semibold mb-2">本文</label>
        <div id="editor" class="mb-6"></div>
        <input type="hidden" name="content" id="content-hidden">

        <!--
          action によって保存ステータスを分岐
          ・draft  : 下書き
          ・public : 公開
        -->
        <button type="submit" name="action" value="draft"
                class="px-4 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-white rounded">
            下書き保存
        </button>

        <button type="submit" name="action" value="public"
                class="px-4 py-3 bg-red-600 text-white rounded hover:bg-red-700 text-white rounded">
            公開する
        </button>
    </form>
</div>

<!-- 管理画面：投稿一覧へ戻る -->
<a href="/admin/posts" class="text-blue-500 hover:text-blue-400 mt-6 block">← 一覧に戻る</a>

<!-- ======================= -->
<!-- Toast UI Editor -->
<!-- ======================= -->
<!--
  外部ライブラリ
  ・WYSIWYG エディタ
  ・colorSyntax プラグイン使用
-->
<script src="https://uicdn.toast.com/editor/3.1.2/toastui-editor-all.min.js"></script>
<script src="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.min.js"></script>
<script src="https://uicdn.toast.com/editor-plugin-color-syntax/latest/toastui-editor-plugin-color-syntax.min.js"></script>

<script>
    // エディタ初期化
    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '600px',
        initialEditType: 'wysiwyg',
        plugins: [toastui.Editor.plugin.colorSyntax]
    });

    // フォーム送信時に Markdown を hidden input に格納
    document.querySelector("form").addEventListener("submit", () => {
        document.querySelector("#content-hidden").value = editor.getMarkdown();
    });
</script>

<!--
  JSへカテゴリデータを渡す
  ・category_control.js が参照
-->
<script>
    window.categories = {{ categories | tojson | safe }};
    window.topics = {{ topics | tojson | safe }};
    window.groups = {{ groups | tojson | safe }};
</script>

<!--
  カテゴリ / トピック / グループ連動制御
-->
<script src="/static/js/category_control.js"></script>

{% endblock %}
